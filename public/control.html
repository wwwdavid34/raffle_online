<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Raffle - Control Panel</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .control-header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--color-border, #e0e0e0);
    }
    .control-header h1 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }
    .session-badge {
      display: inline-block;
      font-family: monospace;
      font-size: 1.5rem;
      font-weight: bold;
      background: var(--color-primary);
      color: white;
      padding: 8px 20px;
      border-radius: 8px;
      letter-spacing: 0.2rem;
    }
    .state-indicator {
      margin-top: 0.75rem;
      font-size: 0.875rem;
    }
    .state-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .state-OPEN { background: var(--color-success); color: white; }
    .state-LOCKED { background: var(--color-warning); color: white; }
    .state-DRAWING { background: var(--color-primary); color: white; }
    .state-CLAIMING { background: var(--color-primary); color: white; }
    .state-CLOSED { background: var(--color-text-secondary); color: white; }

    .stats-row {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--color-surface-2, #f5f5f5);
      border-radius: 12px;
    }
    .stat-item {
      text-align: center;
    }
    .stat-item .value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--color-primary);
    }
    .stat-item .label {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
      text-transform: uppercase;
    }

    .control-section {
      margin-bottom: 1.5rem;
    }
    .control-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      margin-bottom: 0.75rem;
    }

    .control-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .control-buttons .btn {
      padding: 1rem;
      font-size: 1rem;
      font-weight: 600;
    }
    .control-buttons .btn-large {
      padding: 1.5rem;
      font-size: 1.25rem;
    }

    .winner-info {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary, #6366f1) 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 1rem;
    }
    .winner-info .winner-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      opacity: 0.9;
    }
    .winner-info .winner-ticket {
      font-size: 2rem;
      font-weight: bold;
      font-family: monospace;
      margin: 0.5rem 0;
    }
    .winner-info .winner-batch {
      font-size: 0.875rem;
      opacity: 0.9;
    }
    .winner-info .countdown {
      font-size: 2.5rem;
      font-weight: bold;
      margin-top: 0.5rem;
    }
    .winner-info .countdown.urgent {
      color: #ff6b6b;
      animation: pulse 0.5s ease-in-out infinite alternate;
    }

    .scan-link {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--color-surface, #fff);
      border: 2px dashed var(--color-border, #e0e0e0);
      border-radius: 12px;
      color: var(--color-text);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s;
    }
    .scan-link:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .time-setting {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--color-surface-2, #f5f5f5);
      border-radius: 8px;
    }
    .time-setting label {
      flex: 1;
      font-size: 0.875rem;
    }
    .time-setting select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--color-border, #e0e0e0);
      font-size: 1rem;
    }

    .closed-message {
      text-align: center;
      padding: 2rem;
    }
    .closed-message h2 {
      color: var(--color-text-secondary);
    }

    @keyframes pulse {
      from { opacity: 1; }
      to { opacity: 0.6; }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Session Code Entry View (when no session ID in URL) -->
    <div id="codeView" class="view active">
      <h1 data-i18n="control.title">Control Panel</h1>
      <p class="text-center text-secondary" data-i18n="control.enterPin">Enter session code to access controls</p>
      <div id="codeError" class="error-message hidden"></div>

      <div class="card" style="max-width: 400px; margin: 0 auto;">
        <div class="pin-input-container">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="0">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="1">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="2">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="3">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="4">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="5">
        </div>
      </div>
    </div>

    <!-- Passcode Entry View (when session requires authentication) -->
    <div id="passcodeView" class="view">
      <h1 data-i18n="control.enterPasscode">Enter Passcode</h1>
      <div id="passcodeError" class="error-message hidden"></div>

      <div class="card" style="max-width: 400px; margin: 0 auto;">
        <p class="text-center text-secondary mb-2" data-i18n="control.passcodeRequired">This session requires a passcode</p>
        <div class="pin-input-container">
          <input type="text" class="pin-input passcode-input" maxlength="1" inputmode="numeric" data-index="0">
          <input type="text" class="pin-input passcode-input" maxlength="1" inputmode="numeric" data-index="1">
          <input type="text" class="pin-input passcode-input" maxlength="1" inputmode="numeric" data-index="2">
          <input type="text" class="pin-input passcode-input" maxlength="1" inputmode="numeric" data-index="3">
        </div>
      </div>
    </div>

    <!-- Main Control View -->
    <div id="mainView" class="view">
      <div class="card">
        <div class="control-header">
          <h1 id="eventName"></h1>
          <div class="session-badge" id="sessionBadge"></div>
          <div class="state-indicator">
            <span data-i18n="control.status">Status:</span>
            <span class="state-badge" id="stateBadge"></span>
          </div>
        </div>

        <div id="error" class="error-message hidden"></div>

        <!-- Stats Row -->
        <div class="stats-row">
          <div class="stat-item">
            <div class="value" id="statTotal">0</div>
            <div class="label" data-i18n="control.stats.total">Total</div>
          </div>
          <div class="stat-item">
            <div class="value" id="statAvailable">0</div>
            <div class="label" data-i18n="control.stats.available">Available</div>
          </div>
          <div class="stat-item">
            <div class="value" id="statWinners">0</div>
            <div class="label" data-i18n="control.stats.winners">Winners</div>
          </div>
        </div>

        <!-- Open State Controls -->
        <div id="openControls" class="control-section hidden">
          <div class="control-section-title" data-i18n="control.registration">Registration</div>
          <div class="control-buttons">
            <button type="button" id="lockBtn" class="btn btn-warning btn-large">
              <span data-i18n="draw.lockRegistration">Lock Registration</span>
            </button>
          </div>
        </div>

        <!-- Locked State Controls -->
        <div id="lockedControls" class="control-section hidden">
          <div class="control-section-title" data-i18n="control.drawing">Drawing</div>
          <div class="control-buttons">
            <button type="button" id="drawBtn" class="btn btn-success btn-large">
              <span data-i18n="draw.startDraw">Draw Winner</span>
            </button>
            <button type="button" id="reopenBtn" class="btn btn-warning">
              <span data-i18n="draw.reopen">Reopen Registration</span>
            </button>
            <button type="button" id="closeSessionBtn" class="btn btn-secondary">
              <span data-i18n="draw.closeSession">End Raffle</span>
            </button>
          </div>
        </div>

        <!-- Winner Controls -->
        <div id="winnerControls" class="control-section hidden">
          <div class="winner-info">
            <div class="winner-label" data-i18n="draw.winner">WINNER</div>
            <div class="winner-ticket" id="winnerTicket"></div>
            <div class="winner-batch" id="winnerBatch"></div>
            <div class="countdown" id="countdown">60</div>
          </div>
          <div class="control-buttons">
            <button type="button" id="confirmClaimBtn" class="btn btn-success btn-large">
              <span data-i18n="draw.confirmClaim">Confirm Claim</span>
            </button>
            <button type="button" id="redrawBtn" class="btn btn-warning">
              <span data-i18n="draw.redraw">Redraw</span>
            </button>
          </div>
        </div>

        <!-- Closed State -->
        <div id="closedControls" class="control-section hidden">
          <div class="closed-message">
            <h2 data-i18n="thanks.title">Raffle Ended</h2>
            <p class="text-secondary" data-i18n="control.sessionClosed">This session has been closed.</p>
          </div>
        </div>

        <!-- Quick Actions (always visible when not closed) -->
        <div id="quickActions" class="control-section">
          <div class="control-section-title" data-i18n="control.quickActions">Quick Actions</div>
          <a href="#" id="scanLink" class="scan-link">
            <span>ðŸ“±</span>
            <span data-i18n="control.scanTicket">Scan & Verify Ticket</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <script src="/i18n.js"></script>
  <script>
    // Get session ID from URL: /s/{sessionId}/control or /control
    const pathParts = window.location.pathname.split('/');
    let currentSessionId = null;

    if (pathParts[1] === 's' && pathParts[2]) {
      currentSessionId = pathParts[2];
    }

    let sessionData = null;
    let dashboardData = null;
    let countdownInterval = null;
    let pollInterval = null;
    let storedPasscode = null;

    // DOM Elements
    const codeView = document.getElementById('codeView');
    const passcodeView = document.getElementById('passcodeView');
    const mainView = document.getElementById('mainView');
    const codeInputs = document.querySelectorAll('.code-input');
    const passcodeInputs = document.querySelectorAll('.passcode-input');
    const codeError = document.getElementById('codeError');
    const passcodeError = document.getElementById('passcodeError');
    const errorDiv = document.getElementById('error');

    // Control sections
    const openControls = document.getElementById('openControls');
    const lockedControls = document.getElementById('lockedControls');
    const winnerControls = document.getElementById('winnerControls');
    const closedControls = document.getElementById('closedControls');
    const quickActions = document.getElementById('quickActions');

    init();

    async function init() {
      if (currentSessionId) {
        try {
          const response = await fetch(`/api/session/${currentSessionId}`);
          if (!response.ok) throw new Error('Session not found');

          sessionData = await response.json();
          setLanguage(sessionData.language);

          if (sessionData.theme && sessionData.theme !== 'default') {
            document.documentElement.setAttribute('data-theme', sessionData.theme);
          }

          if (sessionData.hasPasscode) {
            showView('passcode');
            setupPasscodeInputs();
          } else {
            showView('main');
            updateUI();
            startPolling();
          }
        } catch (err) {
          showError(err.message);
        }
      } else {
        showView('code');
        setupCodeInputs();
      }

      setupButtons();
    }

    function showView(view) {
      codeView.classList.remove('active');
      passcodeView.classList.remove('active');
      mainView.classList.remove('active');

      switch (view) {
        case 'code':
          codeView.classList.add('active');
          break;
        case 'passcode':
          passcodeView.classList.add('active');
          break;
        case 'main':
          mainView.classList.add('active');
          break;
      }
    }

    function setupCodeInputs() {
      codeInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          const value = e.target.value.replace(/\D/g, '');
          e.target.value = value;

          if (value && index < codeInputs.length - 1) {
            codeInputs[index + 1].focus();
          }

          const code = Array.from(codeInputs).map(i => i.value).join('');
          if (code.length === 6) verifySessionCode(code);
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            codeInputs[index - 1].focus();
          }
        });

        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text');
          const digits = paste.replace(/\D/g, '').slice(0, 6);
          digits.split('').forEach((digit, i) => {
            if (codeInputs[i]) codeInputs[i].value = digit;
          });
          if (digits.length === 6) verifySessionCode(digits);
        });
      });

      codeInputs[0].focus();
    }

    async function verifySessionCode(code) {
      try {
        const checkResponse = await fetch(`/api/session/${code}`);
        if (!checkResponse.ok) throw new Error(t('error.sessionNotFound'));
        window.location.href = `/s/${code}/control`;
      } catch (err) {
        codeError.textContent = err.message;
        codeError.classList.remove('hidden');
        codeInputs.forEach(i => i.value = '');
        codeInputs[0].focus();
      }
    }

    function setupPasscodeInputs() {
      passcodeInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          const value = e.target.value.replace(/\D/g, '');
          e.target.value = value;

          if (value && index < passcodeInputs.length - 1) {
            passcodeInputs[index + 1].focus();
          }

          const passcode = Array.from(passcodeInputs).map(i => i.value).join('');
          if (passcode.length === 4) verifyPasscode(passcode);
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            passcodeInputs[index - 1].focus();
          }
        });

        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text');
          const digits = paste.replace(/\D/g, '').slice(0, 4);
          digits.split('').forEach((digit, i) => {
            if (passcodeInputs[i]) passcodeInputs[i].value = digit;
          });
          if (digits.length === 4) verifyPasscode(digits);
        });
      });

      passcodeInputs[0].focus();
    }

    async function verifyPasscode(passcode) {
      try {
        const response = await fetch(`/api/session/${currentSessionId}/verify-passcode`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ passcode })
        });

        const data = await response.json();

        if (data.valid) {
          storedPasscode = passcode;
          showView('main');
          updateUI();
          startPolling();
        } else {
          passcodeError.textContent = t('error.invalidPasscode');
          passcodeError.classList.remove('hidden');
          passcodeInputs.forEach(i => i.value = '');
          passcodeInputs[0].focus();
        }
      } catch (err) {
        passcodeError.textContent = err.message;
        passcodeError.classList.remove('hidden');
        passcodeInputs.forEach(i => i.value = '');
        passcodeInputs[0].focus();
      }
    }

    function setupButtons() {
      document.getElementById('lockBtn').addEventListener('click', lockRegistration);
      document.getElementById('reopenBtn').addEventListener('click', reopenRegistration);
      document.getElementById('drawBtn').addEventListener('click', drawWinner);
      document.getElementById('redrawBtn').addEventListener('click', redraw);
      document.getElementById('confirmClaimBtn').addEventListener('click', confirmClaim);
      document.getElementById('closeSessionBtn').addEventListener('click', closeSession);
    }

    function updateUI() {
      // Header info
      document.getElementById('eventName').textContent = sessionData.eventName;
      document.getElementById('sessionBadge').textContent = currentSessionId;
      document.title = `${sessionData.eventName} - Control`;

      // State badge
      const badge = document.getElementById('stateBadge');
      badge.textContent = t(`state.${sessionData.state}`) || sessionData.state;
      badge.className = `state-badge state-${sessionData.state}`;

      // Stats
      document.getElementById('statTotal').textContent = sessionData.ticketCount || 0;
      document.getElementById('statAvailable').textContent = sessionData.availableTickets || 0;
      document.getElementById('statWinners').textContent = sessionData.winnersCount || 0;

      // Scan link
      document.getElementById('scanLink').href = `/s/${currentSessionId}/scan`;

      // Show appropriate controls based on state
      updateControls();
    }

    function updateControls() {
      openControls.classList.add('hidden');
      lockedControls.classList.add('hidden');
      winnerControls.classList.add('hidden');
      closedControls.classList.add('hidden');
      quickActions.classList.remove('hidden');

      const state = sessionData.state;
      const hasWinner = sessionData.currentWinner;

      if (state === 'CLOSED') {
        closedControls.classList.remove('hidden');
        quickActions.classList.add('hidden');
        return;
      }

      if (hasWinner) {
        winnerControls.classList.remove('hidden');
        showWinner(sessionData.currentWinner);
      } else if (state === 'OPEN') {
        openControls.classList.remove('hidden');
      } else if (state === 'LOCKED' || state === 'DRAWING') {
        lockedControls.classList.remove('hidden');
        document.getElementById('drawBtn').disabled = (sessionData.availableTickets || 0) === 0;
      }
    }

    function showWinner(winner) {
      document.getElementById('winnerTicket').textContent = winner.ticketId;
      document.getElementById('winnerBatch').textContent = winner.batchLabel || winner.ticketId.split('-')[0];
      startCountdown(winner.claimDeadline);
    }

    function startCountdown(deadline) {
      const countdownEl = document.getElementById('countdown');

      if (countdownInterval) clearInterval(countdownInterval);

      function update() {
        const remaining = Math.max(0, Math.ceil((deadline - Date.now()) / 1000));
        countdownEl.textContent = remaining;

        if (remaining <= 10) {
          countdownEl.classList.add('urgent');
        } else {
          countdownEl.classList.remove('urgent');
        }
      }

      update();
      countdownInterval = setInterval(update, 1000);
    }

    function startPolling() {
      pollInterval = setInterval(async () => {
        try {
          const response = await fetch(`/api/session/${currentSessionId}`);
          if (!response.ok) return;

          sessionData = await response.json();
          updateUI();
        } catch (err) {
          console.error('Poll error:', err);
        }
      }, 1000); // Poll every 1 second for responsive control
    }

    async function lockRegistration() {
      const btn = document.getElementById('lockBtn');
      btn.disabled = true;

      try {
        const response = await fetch(`/api/session/${currentSessionId}/lock`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ passcode: storedPasscode })
        });
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to lock');
        }
        sessionData.state = 'LOCKED';
        updateUI();
      } catch (err) {
        showError(err.message);
      } finally {
        btn.disabled = false;
      }
    }

    async function reopenRegistration() {
      const btn = document.getElementById('reopenBtn');
      btn.disabled = true;

      try {
        const response = await fetch(`/api/session/${currentSessionId}/reopen`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ passcode: storedPasscode })
        });
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to reopen');
        }
        sessionData.state = 'OPEN';
        updateUI();
      } catch (err) {
        showError(err.message);
      } finally {
        btn.disabled = false;
      }
    }

    async function drawWinner() {
      const btn = document.getElementById('drawBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Drawing...';

      try {
        const response = await fetch(`/api/session/${currentSessionId}/draw`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ passcode: storedPasscode })
        });
        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Failed to draw');

        sessionData.currentWinner = data;
        sessionData.state = 'DRAWING';
        updateUI();
      } catch (err) {
        showError(err.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = `<span data-i18n="draw.startDraw">${t('draw.startDraw')}</span>`;
      }
    }

    async function redraw() {
      const btn = document.getElementById('redrawBtn');
      btn.disabled = true;

      if (countdownInterval) clearInterval(countdownInterval);

      try {
        const response = await fetch(`/api/session/${currentSessionId}/redraw`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ passcode: storedPasscode })
        });
        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Failed to redraw');

        sessionData.currentWinner = data;
        showWinner(data);
      } catch (err) {
        showError(err.message);
      } finally {
        btn.disabled = false;
      }
    }

    async function confirmClaim() {
      const btn = document.getElementById('confirmClaimBtn');
      btn.disabled = true;

      if (countdownInterval) clearInterval(countdownInterval);

      try {
        const response = await fetch(`/api/session/${currentSessionId}/confirm-claim`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ passcode: storedPasscode })
        });
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to confirm');
        }

        // Refresh session data
        const statusResponse = await fetch(`/api/session/${currentSessionId}`);
        sessionData = await statusResponse.json();
        sessionData.currentWinner = null;
        updateUI();
      } catch (err) {
        showError(err.message);
      } finally {
        btn.disabled = false;
      }
    }

    async function closeSession() {
      if (!confirm(t('control.confirmClose') || 'Are you sure you want to end this raffle?')) {
        return;
      }

      try {
        const response = await fetch(`/api/session/${currentSessionId}/close`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ passcode: storedPasscode })
        });
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to close');
        }

        sessionData.state = 'CLOSED';
        if (pollInterval) clearInterval(pollInterval);
        updateUI();
      } catch (err) {
        showError(err.message);
      }
    }

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 5000);
    }
  </script>
</body>
</html>

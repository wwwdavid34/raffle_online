<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Event Dashboard</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.2.2/build/qrcode.min.js"></script>
  <style>
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .dashboard-header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    .session-meta {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .session-id {
      font-family: monospace;
      font-size: 1rem;
      background: var(--color-surface-2, #f0f0f0);
      padding: 4px 12px;
      border-radius: 6px;
    }
    .state-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .state-OPEN { background: var(--color-success); color: white; }
    .state-LOCKED { background: var(--color-warning); color: white; }
    .state-DRAWING { background: var(--color-primary); color: white; }
    .state-CLAIMING { background: var(--color-primary); color: white; }
    .state-CLOSED { background: var(--color-text-secondary); color: white; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 16px 0;
    }
    @media (min-width: 600px) {
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    .stat-card {
      background: var(--color-surface, #fff);
      border: 1px solid var(--color-border, #e0e0e0);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-primary);
    }
    .stat-label {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      margin-top: 4px;
    }
    .stat-sub {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      margin-top: 4px;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 24px 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title .count {
      background: var(--color-surface-2, #f0f0f0);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    .data-table th,
    .data-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--color-border, #e0e0e0);
    }
    .data-table th {
      font-weight: 600;
      color: var(--color-text-secondary);
      font-size: 0.75rem;
      text-transform: uppercase;
    }
    .data-table tbody tr:hover {
      background: var(--color-surface-2, #f8f8f8);
    }
    .table-container {
      overflow-x: auto;
      background: var(--color-surface, #fff);
      border: 1px solid var(--color-border, #e0e0e0);
      border-radius: 12px;
    }

    .status-pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-claimed { background: #d4edda; color: #155724; }
    .status-unclaimed { background: #fff3cd; color: #856404; }
    .status-winner { background: #ffd700; color: #000; }
    .status-prize-claimed { background: #d4edda; color: #155724; }
    .status-pending { background: #cce5ff; color: #004085; }

    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: var(--color-text-secondary);
    }
    .empty-state-icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .refresh-indicator {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
      text-align: center;
      margin-top: 16px;
    }

    .nav-links {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .nav-link {
      padding: 8px 16px;
      background: var(--color-surface-2, #f0f0f0);
      border-radius: 8px;
      text-decoration: none;
      color: var(--color-text);
      font-size: 0.875rem;
    }
    .nav-link:hover {
      background: var(--color-border, #e0e0e0);
    }

    .duration {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
    }

    .qr-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .qr-tab {
      padding: 8px 16px;
      border: 1px solid var(--color-primary);
      border-radius: 8px;
      background: var(--color-surface, #fff);
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--color-primary);
      cursor: pointer;
      transition: all 0.2s;
    }
    .qr-tab:hover {
      background: var(--color-primary);
      color: white;
    }
    .qr-tab.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }
    .qr-display {
      background: var(--color-surface, #fff);
      border: 1px solid var(--color-border, #e0e0e0);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .qr-display canvas {
      display: block;
      margin: 0 auto 12px;
      border-radius: 8px;
    }
    .qr-display-label {
      font-size: 1rem;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 4px;
    }
    .qr-display-url {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
      word-break: break-all;
      margin-bottom: 12px;
    }
    .qr-actions {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .qr-action-btn {
      padding: 8px 16px;
      border: 1px solid var(--color-primary);
      border-radius: 8px;
      background: var(--color-surface, #fff);
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      color: var(--color-primary);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .qr-action-btn:hover {
      background: var(--color-primary);
      color: white;
    }
    .qr-action-btn.copied {
      background: var(--color-success);
      color: white;
      border-color: var(--color-success);
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Session Code Entry View (when no session ID in URL) -->
    <div id="codeView" class="view active">
      <div class="card">
        <h1 class="text-center" data-i18n="dashboard.title">Event Dashboard</h1>
        <p class="text-center text-secondary" data-i18n="handout.enterPin">Enter Session Code</p>
        <div id="codeError" class="error-message hidden"></div>

        <div class="pin-input-container">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="0">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="1">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="2">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="3">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="4">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="5">
        </div>
      </div>
    </div>

    <!-- Passcode Entry View (when session requires authentication) -->
    <div id="passcodeView" class="view">
      <div class="card">
        <h1 class="text-center" data-i18n="control.enterPasscode">Enter Passcode</h1>
        <div id="passcodeError" class="error-message hidden"></div>

        <p class="text-center text-secondary mb-2" data-i18n="control.passcodeRequired">This session requires a passcode</p>
        <div class="pin-input-container">
          <input type="text" class="pin-input passcode-input" maxlength="1" inputmode="numeric" data-index="0">
          <input type="text" class="pin-input passcode-input" maxlength="1" inputmode="numeric" data-index="1">
          <input type="text" class="pin-input passcode-input" maxlength="1" inputmode="numeric" data-index="2">
          <input type="text" class="pin-input passcode-input" maxlength="1" inputmode="numeric" data-index="3">
        </div>
      </div>
    </div>

    <!-- Dashboard View -->
    <div id="dashboardView" class="view">
      <div class="card">
        <div class="dashboard-header">
          <div>
            <h1 id="eventName"></h1>
            <div class="duration" id="sessionDuration"></div>
          </div>
          <div class="session-meta">
            <span class="session-id" id="sessionId"></span>
            <span class="state-badge" id="stateBadge"></span>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statTotalBatches">0</div>
            <div class="stat-label" data-i18n="dashboard.stats.batches">Batches</div>
            <div class="stat-sub" id="statClaimedBatches"></div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statTotalTickets">0</div>
            <div class="stat-label" data-i18n="dashboard.stats.tickets">Tickets</div>
            <div class="stat-sub" id="statEligibleTickets"></div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statWinnersDrawn">0</div>
            <div class="stat-label" data-i18n="dashboard.stats.winners">Winners</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statPrizesClaimed">0</div>
            <div class="stat-label" data-i18n="dashboard.stats.claimed">Claimed</div>
          </div>
        </div>

        <!-- Batches Section -->
        <div class="section-title">
          <span data-i18n="dashboard.batches.title">Ticket Batches</span>
          <span class="count" id="batchCount">0</span>
        </div>
        <div class="table-container">
          <table class="data-table" id="batchesTable">
            <thead>
              <tr>
                <th data-i18n="dashboard.batches.id">ID</th>
                <th data-i18n="dashboard.batches.label">Label</th>
                <th data-i18n="dashboard.batches.tickets">Tickets</th>
                <th data-i18n="dashboard.batches.status">Status</th>
                <th data-i18n="dashboard.batches.time">Time</th>
              </tr>
            </thead>
            <tbody id="batchesBody">
            </tbody>
          </table>
          <div id="batchesEmpty" class="empty-state hidden">
            <div class="empty-state-icon">ðŸ“‹</div>
            <div data-i18n="dashboard.batches.empty">No batches created yet</div>
          </div>
        </div>

        <!-- Winners Section -->
        <div class="section-title">
          <span data-i18n="dashboard.winners.title">Winners</span>
          <span class="count" id="winnerCount">0</span>
        </div>
        <div class="table-container">
          <table class="data-table" id="winnersTable">
            <thead>
              <tr>
                <th data-i18n="dashboard.winners.ticket">Ticket</th>
                <th data-i18n="dashboard.winners.batch">Batch</th>
                <th data-i18n="dashboard.winners.status">Status</th>
              </tr>
            </thead>
            <tbody id="winnersBody">
            </tbody>
          </table>
          <div id="winnersEmpty" class="empty-state hidden">
            <div class="empty-state-icon">ðŸŽ¯</div>
            <div data-i18n="dashboard.winners.empty">No winners drawn yet</div>
          </div>
        </div>

        <!-- QR Codes Section -->
        <div class="section-title">
          <span data-i18n="dashboard.qr.title">Quick Access QR Codes</span>
        </div>
        <div class="qr-tabs" id="qrTabs">
          <button type="button" class="qr-tab active" data-page="control" data-i18n="dashboard.qr.control">Control</button>
          <button type="button" class="qr-tab" data-page="handout" data-i18n="dashboard.qr.handout">Hand Out</button>
          <button type="button" class="qr-tab" data-page="draw" data-i18n="dashboard.qr.draw">Draw</button>
          <button type="button" class="qr-tab" data-page="scan" data-i18n="dashboard.qr.scan">Scan</button>
          <button type="button" class="qr-tab" data-page="dashboard" data-i18n="dashboard.qr.dashboard">Dashboard</button>
        </div>
        <div class="qr-display">
          <canvas id="qrCanvas"></canvas>
          <div class="qr-display-label" id="qrLabel">Control</div>
          <div class="qr-display-url" id="qrUrl"></div>
          <div class="qr-actions">
            <a href="#" id="qrOpenLink" class="qr-action-btn" target="_blank">â†— Open</a>
            <button type="button" id="qrCopyBtn" class="qr-action-btn">â§‰ Copy</button>
          </div>
        </div>

        <div class="nav-links">
          <a href="#" id="linkControl" class="nav-link">âš™ Control</a>
          <a href="#" id="linkHandout" class="nav-link">â†— Hand Out</a>
          <a href="#" id="linkDraw" class="nav-link">â–¶ Draw</a>
          <a href="#" id="linkScan" class="nav-link">â—Ž Scan</a>
        </div>

        <div class="refresh-indicator" data-i18n="dashboard.autoRefresh">Auto-refreshing every 2 seconds</div>
      </div>
    </div>

    <!-- Error View -->
    <div id="errorView" class="view">
      <div class="card text-center">
        <h2 data-i18n="error.sessionNotFound">Session Not Found</h2>
        <p class="text-secondary" id="errorMessage"></p>
        <button type="button" class="btn btn-primary mt-2" onclick="location.reload()" data-i18n="common.tryAgain">Try Again</button>
      </div>
    </div>
  </div>

  <script src="/i18n.js"></script>
  <script>
    // Parse URL for session ID
    const pathParts = window.location.pathname.split('/');
    let currentSessionId = null;

    if (pathParts[1] === 's' && pathParts[2]) {
      currentSessionId = pathParts[2];
    }

    let sessionData = null;
    let dashboardData = null;
    let pollInterval = null;
    let storedPasscode = null;

    // DOM elements
    const codeView = document.getElementById('codeView');
    const passcodeView = document.getElementById('passcodeView');
    const dashboardView = document.getElementById('dashboardView');
    const errorView = document.getElementById('errorView');
    const codeInputs = document.querySelectorAll('.code-input');
    const passcodeInputs = document.querySelectorAll('.passcode-input');
    const codeError = document.getElementById('codeError');
    const passcodeError = document.getElementById('passcodeError');

    init();

    async function init() {
      if (currentSessionId) {
        try {
          const response = await fetch(`/api/session/${currentSessionId}`);
          if (!response.ok) throw new Error('Session not found');

          sessionData = await response.json();
          setLanguage(sessionData.language);

          if (sessionData.theme && sessionData.theme !== 'default') {
            document.documentElement.setAttribute('data-theme', sessionData.theme);
          }

          if (sessionData.hasPasscode) {
            showView('passcode');
            setupPasscodeInputs();
          } else {
            await loadDashboard();
          }
        } catch (err) {
          document.getElementById('errorMessage').textContent = err.message;
          showView('error');
        }
      } else {
        showView('code');
        setupCodeInputs();
      }
    }

    function setupCodeInputs() {
      codeInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          const value = e.target.value.replace(/\D/g, '');
          e.target.value = value;

          if (value && index < codeInputs.length - 1) {
            codeInputs[index + 1].focus();
          }

          const code = Array.from(codeInputs).map(i => i.value).join('');
          if (code.length === 6) verifySessionCode(code);
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            codeInputs[index - 1].focus();
          }
        });

        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text');
          const digits = paste.replace(/\D/g, '').slice(0, 6);
          digits.split('').forEach((digit, i) => {
            if (codeInputs[i]) codeInputs[i].value = digit;
          });
          if (digits.length === 6) verifySessionCode(digits);
        });
      });

      codeInputs[0].focus();
    }

    async function verifySessionCode(code) {
      try {
        const checkResponse = await fetch(`/api/session/${code}`);
        if (!checkResponse.ok) throw new Error(t('error.sessionNotFound'));
        window.location.href = `/s/${code}/dashboard`;
      } catch (err) {
        codeError.textContent = err.message;
        codeError.classList.remove('hidden');
        codeInputs.forEach(i => i.value = '');
        codeInputs[0].focus();
      }
    }

    function setupPasscodeInputs() {
      passcodeInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          const value = e.target.value.replace(/\D/g, '');
          e.target.value = value;

          if (value && index < passcodeInputs.length - 1) {
            passcodeInputs[index + 1].focus();
          }

          const passcode = Array.from(passcodeInputs).map(i => i.value).join('');
          if (passcode.length === 4) verifyPasscode(passcode);
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            passcodeInputs[index - 1].focus();
          }
        });

        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text');
          const digits = paste.replace(/\D/g, '').slice(0, 4);
          digits.split('').forEach((digit, i) => {
            if (passcodeInputs[i]) passcodeInputs[i].value = digit;
          });
          if (digits.length === 4) verifyPasscode(digits);
        });
      });

      passcodeInputs[0].focus();
    }

    async function verifyPasscode(passcode) {
      try {
        const response = await fetch(`/api/session/${currentSessionId}/verify-passcode`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ passcode })
        });

        const data = await response.json();

        if (data.valid) {
          storedPasscode = passcode;
          await loadDashboard();
        } else {
          passcodeError.textContent = t('error.invalidPasscode');
          passcodeError.classList.remove('hidden');
          passcodeInputs.forEach(i => i.value = '');
          passcodeInputs[0].focus();
        }
      } catch (err) {
        passcodeError.textContent = err.message;
        passcodeError.classList.remove('hidden');
        passcodeInputs.forEach(i => i.value = '');
        passcodeInputs[0].focus();
      }
    }

    async function loadDashboard() {
      try {
        const response = await fetch(`/api/session/${currentSessionId}/dashboard`);
        if (!response.ok) {
          throw new Error('Failed to load dashboard');
        }

        dashboardData = await response.json();

        // Set language and theme
        setLanguage(dashboardData.session.language);
        if (dashboardData.session.theme && dashboardData.session.theme !== 'default') {
          document.documentElement.setAttribute('data-theme', dashboardData.session.theme);
        }

        updateDashboard();
        showView('dashboard');

        // Start polling
        if (!pollInterval) {
          pollInterval = setInterval(refreshDashboard, 2000);
        }

        // Set up navigation links
        document.getElementById('linkControl').href = `/s/${currentSessionId}/control`;
        document.getElementById('linkHandout').href = `/s/${currentSessionId}/handout`;
        document.getElementById('linkDraw').href = `/s/${currentSessionId}/draw`;
        document.getElementById('linkScan').href = `/s/${currentSessionId}/scan`;

        // Generate QR codes
        generateQRCodes();
        setupCopyButton();

      } catch (err) {
        console.error('Load error:', err);
        document.getElementById('errorMessage').textContent = err.message;
        showView('error');
      }
    }

    async function refreshDashboard() {
      try {
        const response = await fetch(`/api/session/${currentSessionId}/dashboard`);
        if (response.ok) {
          dashboardData = await response.json();
          updateDashboard();
        }
      } catch (err) {
        console.error('Refresh error:', err);
      }
    }

    function updateDashboard() {
      const { session, stats, batches, winners } = dashboardData;

      // Header
      document.getElementById('eventName').textContent = session.eventName;
      document.getElementById('sessionId').textContent = `#${session.sessionId}`;

      const badge = document.getElementById('stateBadge');
      badge.textContent = t(`state.${session.state}`) || session.state;
      badge.className = `state-badge state-${session.state}`;

      // Duration
      const duration = formatDuration(Date.now() - session.createdAt);
      document.getElementById('sessionDuration').textContent = duration;

      // Stats
      document.getElementById('statTotalBatches').textContent = stats.totalBatches;
      document.getElementById('statClaimedBatches').textContent =
        `${stats.claimedBatches} ${t('dashboard.stats.registered')}`;

      document.getElementById('statTotalTickets').textContent = stats.totalTickets;
      document.getElementById('statEligibleTickets').textContent =
        `${stats.eligibleTickets} ${t('dashboard.stats.eligible')}`;

      document.getElementById('statWinnersDrawn').textContent = stats.winnersDrawn;
      document.getElementById('statPrizesClaimed').textContent = stats.prizesClaimed;

      // Batches table
      document.getElementById('batchCount').textContent = batches.length;
      const batchesBody = document.getElementById('batchesBody');
      const batchesEmpty = document.getElementById('batchesEmpty');

      if (batches.length === 0) {
        batchesBody.innerHTML = '';
        batchesEmpty.classList.remove('hidden');
        document.getElementById('batchesTable').classList.add('hidden');
      } else {
        batchesEmpty.classList.add('hidden');
        document.getElementById('batchesTable').classList.remove('hidden');
        batchesBody.innerHTML = batches.map(b => `
          <tr>
            <td><code>${b.batchId}</code></td>
            <td>${b.label || '-'}</td>
            <td>${b.ticketCount}</td>
            <td>
              <span class="status-pill status-${b.status}">
                ${t(`dashboard.batches.status.${b.status}`)}
              </span>
            </td>
            <td>${formatTime(b.claimedAt || b.createdAt)}</td>
          </tr>
        `).join('');
      }

      // Winners table
      document.getElementById('winnerCount').textContent = winners.length;
      const winnersBody = document.getElementById('winnersBody');
      const winnersEmpty = document.getElementById('winnersEmpty');

      if (winners.length === 0) {
        winnersBody.innerHTML = '';
        winnersEmpty.classList.remove('hidden');
        document.getElementById('winnersTable').classList.add('hidden');
      } else {
        winnersEmpty.classList.add('hidden');
        document.getElementById('winnersTable').classList.remove('hidden');
        winnersBody.innerHTML = winners.map(w => `
          <tr>
            <td><code>${w.ticketId}</code></td>
            <td>${w.batchLabel || w.batchId}</td>
            <td>
              <span class="status-pill ${w.claimedAt ? 'status-prize-claimed' : 'status-pending'}">
                ${w.claimedAt ? t('dashboard.winners.status.claimed') : t('dashboard.winners.status.pending')}
              </span>
            </td>
          </tr>
        `).join('');
      }
    }

    function formatDuration(ms) {
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);

      if (hours > 0) {
        return `${hours}h ${minutes % 60}m`;
      } else if (minutes > 0) {
        return `${minutes}m`;
      } else {
        return `${seconds}s`;
      }
    }

    function formatTime(timestamp) {
      if (!timestamp) return '-';
      const date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    let currentQRPage = 'control';

    function generateQRCodes() {
      // Set up tab click handlers
      document.getElementById('qrTabs').addEventListener('click', (e) => {
        const tab = e.target.closest('.qr-tab');
        if (!tab) return;

        const page = tab.dataset.page;
        showQRCode(page);

        // Update active tab
        document.querySelectorAll('.qr-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
      });

      // Show initial QR code
      showQRCode('control');
    }

    function showQRCode(page) {
      currentQRPage = page;
      const baseUrl = window.location.origin;
      const url = `${baseUrl}/s/${currentSessionId}/${page}`;

      const canvas = document.getElementById('qrCanvas');
      const labelEl = document.getElementById('qrLabel');
      const urlEl = document.getElementById('qrUrl');
      const openLink = document.getElementById('qrOpenLink');
      const copyBtn = document.getElementById('qrCopyBtn');

      // Generate QR code
      QRCode.toCanvas(canvas, url, {
        width: 200,
        margin: 2,
        color: { dark: '#000000', light: '#ffffff' }
      }, (err) => {
        if (err) console.error('QR error:', err);
      });

      // Update label and URL
      const labels = {
        control: t('dashboard.qr.control'),
        handout: t('dashboard.qr.handout'),
        draw: t('dashboard.qr.draw'),
        scan: t('dashboard.qr.scan'),
        dashboard: t('dashboard.qr.dashboard')
      };
      labelEl.textContent = labels[page] || page;
      urlEl.textContent = url;

      // Set open link href
      openLink.href = url;

      // Reset copy button state
      copyBtn.classList.remove('copied');
      copyBtn.textContent = 'â§‰ Copy';
    }

    function setupCopyButton() {
      const copyBtn = document.getElementById('qrCopyBtn');
      copyBtn.addEventListener('click', async () => {
        const baseUrl = window.location.origin;
        const url = `${baseUrl}/s/${currentSessionId}/${currentQRPage}`;

        try {
          await navigator.clipboard.writeText(url);
          copyBtn.classList.add('copied');
          copyBtn.textContent = 'âœ“ Copied';

          setTimeout(() => {
            copyBtn.classList.remove('copied');
            copyBtn.textContent = 'â§‰ Copy';
          }, 2000);
        } catch (err) {
          console.error('Copy failed:', err);
        }
      });
    }

    function showView(view) {
      codeView.classList.remove('active');
      passcodeView.classList.remove('active');
      dashboardView.classList.remove('active');
      errorView.classList.remove('active');

      switch (view) {
        case 'code':
          codeView.classList.add('active');
          break;
        case 'passcode':
          passcodeView.classList.add('active');
          break;
        case 'dashboard':
          dashboardView.classList.add('active');
          break;
        case 'error':
          errorView.classList.add('active');
          break;
      }
    }
  </script>
</body>
</html>

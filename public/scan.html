<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-67MVYE0NVR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-67MVYE0NVR');
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Raffle - Verify Ticket</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
  <div id="app">
    <!-- Session Code Entry View (when no session ID in URL) -->
    <div id="codeView" class="view active">
      <h1 data-i18n="handout.enterPin">Enter Session Code</h1>
      <div id="codeError" class="error-message hidden"></div>

      <div class="card">
        <div class="pin-input-container">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="0">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="1">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="2">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="3">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="4">
          <input type="text" class="pin-input code-input" maxlength="1" inputmode="numeric" data-index="5">
        </div>
      </div>
    </div>

    <!-- Passcode Entry View (when session requires authentication) -->
    <div id="passcodeView" class="view">
      <h1 data-i18n="control.enterPasscode">Enter Passcode</h1>
      <div id="passcodeError" class="error-message hidden"></div>

      <div class="card">
        <p class="text-center text-secondary mb-2" data-i18n="control.passcodeRequired">This session requires a passcode</p>
        <div class="pin-input-container">
          <input type="text" class="pin-input passcode-input" maxlength="1" inputmode="numeric" data-index="0">
          <input type="text" class="pin-input passcode-input" maxlength="1" inputmode="numeric" data-index="1">
          <input type="text" class="pin-input passcode-input" maxlength="1" inputmode="numeric" data-index="2">
          <input type="text" class="pin-input passcode-input" maxlength="1" inputmode="numeric" data-index="3">
        </div>
      </div>
    </div>

    <!-- Main Scan View -->
    <div id="mainView" class="view">
      <div class="session-header">
        <div class="session-event-name" id="eventName"></div>
        <div class="session-id" id="sessionId"></div>
      </div>

      <h1 data-i18n="scan.title">Verify Ticket</h1>

      <div id="error" class="error-message hidden"></div>

      <!-- Scanner View -->
      <div id="scannerView">
        <p class="text-center text-secondary mb-2" data-i18n="scan.instruction">
          Scan the winning ticket QR code
        </p>

        <div class="scanner-container">
          <div id="reader"></div>
        </div>
      </div>

      <!-- Result View -->
      <div id="resultView" class="hidden">
        <!-- Valid Result -->
        <div id="validResult" class="scan-result valid hidden">
          <div class="scan-result-icon">&#10004;</div>
          <div class="scan-result-message" data-i18n="scan.result.valid">Valid Winner!</div>
          <div class="mt-2">
            <span data-i18n="draw.ticket">Ticket</span>: <strong id="validTicketId"></strong>
          </div>
        </div>

        <!-- Invalid Results -->
        <div id="notWinnerResult" class="scan-result invalid hidden">
          <div class="scan-result-icon">&#10008;</div>
          <div class="scan-result-message" data-i18n="scan.result.notWinner">Not a winning ticket</div>
        </div>

        <div id="wrongEventResult" class="scan-result invalid hidden">
          <div class="scan-result-icon">&#10008;</div>
          <div class="scan-result-message" data-i18n="scan.result.wrongEvent">Wrong event</div>
        </div>

        <div id="alreadyClaimedResult" class="scan-result invalid hidden">
          <div class="scan-result-icon">&#10008;</div>
          <div class="scan-result-message" data-i18n="scan.result.alreadyClaimed">Already claimed</div>
        </div>

        <div id="invalidResult" class="scan-result invalid hidden">
          <div class="scan-result-icon">&#10008;</div>
          <div class="scan-result-message" data-i18n="scan.result.invalid">Invalid ticket</div>
        </div>

        <!-- Action Buttons -->
        <div class="action-grid mt-3" id="resultActions">
          <button type="button" id="markClaimedBtn" class="btn btn-success hidden">
            <span data-i18n="scan.markClaimed">Mark as Claimed</span>
          </button>
          <button type="button" id="scanAnotherBtn" class="btn btn-primary">
            <span data-i18n="scan.scanAnother">Scan Another</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="/i18n.js"></script>
  <script>
    // Get session ID from URL: /s/{sessionId}/scan or /scan
    const pathParts = window.location.pathname.split('/');
    let currentSessionId = null;

    // Check if URL has session ID: /s/{id}/scan
    if (pathParts[1] === 's' && pathParts[2]) {
      currentSessionId = pathParts[2];
    }

    let sessionData = null;
    let html5QrCode = null;
    let currentResult = null;
    let storedPasscode = null;

    // DOM Elements
    const codeView = document.getElementById('codeView');
    const passcodeView = document.getElementById('passcodeView');
    const mainView = document.getElementById('mainView');
    const codeInputs = document.querySelectorAll('.code-input');
    const passcodeInputs = document.querySelectorAll('.passcode-input');
    const codeError = document.getElementById('codeError');
    const passcodeError = document.getElementById('passcodeError');
    const errorDiv = document.getElementById('error');
    const scannerView = document.getElementById('scannerView');
    const resultView = document.getElementById('resultView');

    // Initialize
    init();

    async function init() {
      if (currentSessionId) {
        try {
          const response = await fetch(`/api/session/${currentSessionId}`);
          if (!response.ok) {
            throw new Error('Session not found');
          }
          sessionData = await response.json();
          setLanguage(sessionData.language);

          if (sessionData.theme && sessionData.theme !== 'default') {
            document.documentElement.setAttribute('data-theme', sessionData.theme);
          }

          document.getElementById('eventName').textContent = sessionData.eventName;
          document.getElementById('sessionId').textContent = `Session: ${currentSessionId}`;
          document.title = `${sessionData.eventName} - Verify`;

          if (sessionData.hasPasscode) {
            showView('passcode');
            setupPasscodeInputs();
          } else {
            showView('main');
            startScanner();
          }
        } catch (err) {
          showError(err.message);
        }
      } else {
        showView('code');
        setupCodeInputs();
      }

      setupButtons();
    }

    function showView(view) {
      codeView.classList.remove('active');
      passcodeView.classList.remove('active');
      mainView.classList.remove('active');

      switch (view) {
        case 'code':
          codeView.classList.add('active');
          break;
        case 'passcode':
          passcodeView.classList.add('active');
          break;
        case 'main':
          mainView.classList.add('active');
          break;
      }
    }

    function setupCodeInputs() {
      codeInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          const value = e.target.value.replace(/\D/g, '');
          e.target.value = value;

          if (value && index < codeInputs.length - 1) {
            codeInputs[index + 1].focus();
          }

          const code = Array.from(codeInputs).map(i => i.value).join('');
          if (code.length === 6) {
            verifySessionCode(code);
          }
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            codeInputs[index - 1].focus();
          }
        });

        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text');
          const digits = paste.replace(/\D/g, '').slice(0, 6);
          digits.split('').forEach((digit, i) => {
            if (codeInputs[i]) codeInputs[i].value = digit;
          });
          if (digits.length === 6) verifySessionCode(digits);
        });
      });

      codeInputs[0].focus();
    }

    async function verifySessionCode(code) {
      try {
        const checkResponse = await fetch(`/api/session/${code}`);
        if (!checkResponse.ok) {
          throw new Error(t('error.sessionNotFound'));
        }
        window.location.href = `/s/${code}/scan`;
      } catch (err) {
        codeError.textContent = err.message;
        codeError.classList.remove('hidden');
        codeInputs.forEach(i => i.value = '');
        codeInputs[0].focus();
      }
    }

    function setupPasscodeInputs() {
      passcodeInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          const value = e.target.value.replace(/\D/g, '');
          e.target.value = value;

          if (value && index < passcodeInputs.length - 1) {
            passcodeInputs[index + 1].focus();
          }

          const passcode = Array.from(passcodeInputs).map(i => i.value).join('');
          if (passcode.length === 4) {
            verifyPasscode(passcode);
          }
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            passcodeInputs[index - 1].focus();
          }
        });

        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text');
          const digits = paste.replace(/\D/g, '').slice(0, 4);
          digits.split('').forEach((digit, i) => {
            if (passcodeInputs[i]) passcodeInputs[i].value = digit;
          });
          if (digits.length === 4) verifyPasscode(digits);
        });
      });

      passcodeInputs[0].focus();
    }

    async function verifyPasscode(passcode) {
      try {
        const response = await fetch(`/api/session/${currentSessionId}/verify-passcode`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ passcode })
        });

        const data = await response.json();

        if (data.valid) {
          storedPasscode = passcode;
          showView('main');
          startScanner();
        } else {
          passcodeError.textContent = t('error.invalidPasscode');
          passcodeError.classList.remove('hidden');
          passcodeInputs.forEach(i => i.value = '');
          passcodeInputs[0].focus();
        }
      } catch (err) {
        passcodeError.textContent = err.message;
        passcodeError.classList.remove('hidden');
        passcodeInputs.forEach(i => i.value = '');
        passcodeInputs[0].focus();
      }
    }

    function setupButtons() {
      document.getElementById('markClaimedBtn').addEventListener('click', markClaimed);
      document.getElementById('scanAnotherBtn').addEventListener('click', resetScanner);
    }

    function startScanner() {
      html5QrCode = new Html5Qrcode("reader");

      const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1
      };

      html5QrCode.start(
        { facingMode: "environment" },
        config,
        onScanSuccess,
        onScanError
      ).catch(err => {
        console.error('Scanner error:', err);
        showError('Camera access denied or not available');
      });
    }

    function stopScanner() {
      if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().catch(err => console.error('Stop error:', err));
      }
    }

    async function onScanSuccess(decodedText) {
      // Stop scanning
      stopScanner();

      try {
        // Parse QR payload
        const payload = JSON.parse(decodedText);

        if (!payload.s || !payload.sig) {
          showResult('invalid');
          return;
        }

        // Verify with backend
        const response = await fetch(`/api/session/${currentSessionId}/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId: payload.s,
            batchId: payload.b,
            ticketId: payload.t !== 'batch' ? payload.t : undefined,
            sig: payload.sig
          })
        });

        const data = await response.json();

        currentResult = data;
        showResult(data.result, data);

      } catch (err) {
        console.error('Scan error:', err);
        showResult('invalid');
      }
    }

    function onScanError(error) {
      // Ignore scan errors (no QR found)
    }

    function showResult(result, data = {}) {
      scannerView.classList.add('hidden');
      resultView.classList.remove('hidden');

      // Hide all result types
      document.getElementById('validResult').classList.add('hidden');
      document.getElementById('notWinnerResult').classList.add('hidden');
      document.getElementById('wrongEventResult').classList.add('hidden');
      document.getElementById('alreadyClaimedResult').classList.add('hidden');
      document.getElementById('invalidResult').classList.add('hidden');
      document.getElementById('markClaimedBtn').classList.add('hidden');

      switch (result) {
        case 'valid':
          document.getElementById('validResult').classList.remove('hidden');
          document.getElementById('validTicketId').textContent = data.ticketId;
          document.getElementById('markClaimedBtn').classList.remove('hidden');
          break;
        case 'notWinner':
          document.getElementById('notWinnerResult').classList.remove('hidden');
          break;
        case 'wrongEvent':
          document.getElementById('wrongEventResult').classList.remove('hidden');
          break;
        case 'alreadyClaimed':
          document.getElementById('alreadyClaimedResult').classList.remove('hidden');
          break;
        default:
          document.getElementById('invalidResult').classList.remove('hidden');
      }
    }

    async function markClaimed() {
      if (!currentResult || !currentResult.ticketId) return;

      const btn = document.getElementById('markClaimedBtn');
      btn.disabled = true;

      try {
        const response = await fetch(`/api/session/${currentSessionId}/mark-claimed`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ticketId: currentResult.ticketId,
            passcode: storedPasscode
          })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to mark claimed');
        }

        // Show success and reset
        btn.textContent = 'Claimed!';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-secondary');

        setTimeout(resetScanner, 1500);

      } catch (err) {
        showError(err.message);
        btn.disabled = false;
      }
    }

    function resetScanner() {
      currentResult = null;
      scannerView.classList.remove('hidden');
      resultView.classList.add('hidden');

      // Reset button
      const btn = document.getElementById('markClaimedBtn');
      btn.disabled = false;
      btn.classList.add('btn-success');
      btn.classList.remove('btn-secondary');
      btn.innerHTML = `<span data-i18n="scan.markClaimed">Mark as Claimed</span>`;
      setLanguage(getLanguage()); // Re-apply translations

      startScanner();
    }

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => {
        errorDiv.classList.add('hidden');
      }, 5000);
    }
  </script>
</body>
</html>
